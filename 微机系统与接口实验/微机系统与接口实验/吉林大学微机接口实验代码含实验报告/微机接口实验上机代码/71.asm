M8251_DATA EQU 0600H
M8251_CON EQU 0602H
M8254_2 EQU 06C4H
M8254_CON EQU 06C6H

SSTACK SEGMENT STACK
	DW 64 DUP(?)
SSTACK ENDS

CODE SEGMENT
	ASSUME CS:CODE
START:
	MOV AX,0000H
	MOV DS,AX	;数据段地址为0000H
	
	MOV AL,0B6H			;076H=0111 0110,计数器1，先低后高，方式3，二进制数
	MOV DX,M8254_CON
	OUT DX,AL
	MOV AL,0CH
	MOV DX,M8254_2
	OUT DX,AL
	MOV AL,00H			;000CH=0...0 1100,
	OUT DX,AL
	
	MOV DX,M8251_CON
	MOV AL,00H			;00H=0000 0000,内双同步，无校验，5位字符长度
	OUT DX,AL
	CALL DELAY	;延时
	
	MOV AL,40H			;40H=0100 0000,外双同步，无校验，5位字符长度
	OUT DX,AL
	CALL DELAY
	
	MOV AL,7EH			;7EH=0111 1110,1位异步，波特率系数为16，偶校验，字符长度为8位
	OUT DX,AL
	CALL DELAY
	
	MOV AL,34H			;34H=0011 0100,内双同步，偶校验，6位字符长度
	OUT DX,AL
	CALL DELAY
	
	MOV DI,4000H
	MOV SI,3000H
	MOV CX,000AH	;循环次数10
	


A1:
	MOV AL,37H			;37H=0011 0111,异步，不用异步位，偶校验，6位字符长度
	MOV DX,M8251_CON
	OUT DX,AL
	
	MOV AL,[SI]	;获得SI地址的数据
	MOV DX,M8251_DATA
	OUT DX,AL	;发送数据给8251串口
	

A2:
	MOV DX,M8251_CON
	IN AL,DX	;获得控制字
	AND AL,01H	;判断发送缓冲是否为空
	JZ A2
	CALL DELAY	;延时
	
A3:
	MOV DX,M8251_CON
	IN AL,DX	;获得控制字
	AND AL,02H	;判断是否接收到数据
	JZ A3
	CALL DELAY	;延时
	
	MOV DX,M8251_DATA
	IN AL,DX	;从8251串口获得数据
	MOV [DI],AL	;保存数据至目标地址
	INC DI
	INC SI		;源和目标地址自增
	LOOP A1		;循环10次
	
	MOV AH,4CH
	INT 21H	;程序终止
	
DELAY:	;延时子程序
	PUSH CX
	MOV CX,3000H
A4: 
    PUSH AX
    POP AX
    LOOP A4
    POP CX
    RET
	
	
CODE ENDS
	END START